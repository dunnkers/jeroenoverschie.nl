name: Deploy Website

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    services:
      ghost:
        image: ghost:5.116.1
        ports:
          - 2368:2368
        volumes:
          - ${{ github.workspace }}/content:/var/lib/ghost/content
        env:
          NODE_ENV: development
          database__client: sqlite3
          database__connection__filename: /var/lib/ghost/content/data/ghost-local.db
          url: http://localhost:2368

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 16

    - name: Install dependencies
      run: npm install -g ghost-static-site-generator gh-pages replace-in-file

    - name: Wait for Ghost to be ready
      run: |
        echo "Waiting for Ghost to start..."
        sleep 10
        # Use curl to check if Ghost is up and running
        until curl -s http://localhost:2368 > /dev/null; do
          echo "Ghost is unavailable - sleeping"
          sleep 5
        done
        echo "Ghost is up and running"

    - name: Build
      run: npm run build

    - name: Deploy
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        npm run deploy
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
